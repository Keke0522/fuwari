<template>
  <div class="app-container">
    <el-form
        ref="queryForm"
        :inline="true"
        :model="queryParams"
        class="form-wrapper"
        label-width="68px"
        size="small"

    >
      <div class="form-left">
        <el-form-item>
          <el-tag type="success"> Âú®Á∫øËÆæÂ§áÊï∞Ôºö{{ onlineCount }}</el-tag>
          <!--          //{-->
          <!--          "startIp": "192.168.1.1",-->
          <!--          "endIp": "192.168.1.254"-->
          <!--          }-->
          <div style="margin-left: 10px">
            <el-input
                v-model="queryParams.startIp"
                clearable
                placeholder="192.168.1.0"
                size="small"
                style="width: 100px; height: 20px; line-height: 20px;"
            />
            -
            <el-input
                v-model="queryParams.endIp"
                clearable
                placeholder="192.168.1.254"
                size="small"
                style="width: 100px; height: 20px; line-height: 20px;"
            />
            <el-button icon="refresh" size="small" style="color: #ffffff" type="text" @click="handleRefresh">Êâ´Êèè
            </el-button>
          </div>

        </el-form-item>
      </div>

      <div class="form-right">
        <el-form-item prop="ipaddress">
          <template #label>
            <span style="color: #ffffff">ip Êü•ËØ¢</span>
          </template>
          <el-input
              v-model="queryParams.ipaddress"
              clearable
              placeholder="ËØ∑ËæìÂÖ•Êü•ËØ¢ ip"
              style="width: 100px; height: 20px; line-height: 20px;"
          />
        </el-form-item>
        <el-form-item>
          <!--          <div v-if="queryParams.ipaddress!=''&&listData.length==0">-->
          <!--            <el-button style="margin-right: 10px"  size="small" icon="plus" @click="handleQuery"  >Ê∑ªÂä†</el-button>-->
          <!--          </div>-->
          <el-button icon="refresh" size="small" @click="resetQuery">ÈáçÁΩÆ</el-button>
          <el-button icon="setting" size="small" @click="showColumnSettings">ÂàóËÆæÁΩÆ</el-button>
        </el-form-item>
      </div>
    </el-form>

    <el-table
        v-loading="loading"
        :data="listData"
        :expand-row-keys="expandedRows"
        :header-cell-style="{ backgroundColor: ' rgba(158, 141, 204, 0.8)', color: 'white', fontWeight: 'bold' }"
        :row-class-name="tableRowClassName"
        :row-key="rowKey"
        height="calc(100vh - 100px)"
        size="small"
        stripe
        style="width: 100%;"
        @expand-change="handleExpandChange"
    >
      <!-- Â±ïÂºÄË°å -->
      <el-table-column type="expand">
        <template #default="{ row }">

          <el-button :disabled="!Object.values(visibleCharts).includes(false)" style="margin-left: 20px" type="text"
                     @click="handleCreate">
            <el-icon style="margin-right: 3px">
              <Refresh/>
            </el-icon>
            ÊÅ¢Â§ç
          </el-button>
          <div class="chart-container">


            <!--            <echars v-if="visibleCharts['mem']"-->
            <!--                    id="mem"-->
            <!--                    :realtimeData="row._chartData?.mem ?? []"-->
            <!--                    title="ÂÜÖÂ≠ò"-->
            <!--                    @destroy="handleDestroy('mem')"/>-->
            <!--            <echars v-if="visibleCharts['disk']"-->
            <!--                    id="disk"-->
            <!--                    :realtimeData="row._chartData?.disk ?? []"-->
            <!--                    title="Á°¨Áõò"-->
            <!--                    @destroy="handleDestroy('disk')"/>-->
            <!--            <echars v-if="visibleCharts['qtwd']"-->
            <!--                    id="qtwd"-->
            <!--                    :realtimeData="row._chartData?.qtwd ?? []"-->
            <!--                    title="ËÖî‰ΩìÊ∏©Â∫¶"-->
            <!--                    @destroy="handleDestroy('qtwd')"/>-->
            <!--            <echars v-if="visibleCharts['spwd']"-->
            <!--                    id="spwd"-->
            <!--                    :realtimeData="row._chartData?.spwd ?? []"-->
            <!--                    title="Â∞ÑÈ¢ëÊ∏©Â∫¶"-->
            <!--                    @destroy="handleDestroy('spwd')"/>-->
            <!--            <echars v-if="visibleCharts['qtsd']"-->
            <!--                    id="qtsd"-->
            <!--                    :realtimeData="row._chartData?.qtsd ?? []"-->
            <!--                    title="ËÖî‰ΩìÊπøÂ∫¶"-->
            <!--                    @destroy="handleDestroy('qtsd')"/>-->
            <net v-if="visibleCharts['yj1']"
                 id="yj1"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.yj1 ?? { name: ['cpu', 'ÂÜÖÂ≠ò', 'Á°¨Áõò'], cpu: [], ÂÜÖÂ≠ò: [], Á°¨Áõò: [] }"
                 title="Á≥ªÁªüËµÑÊ∫ê"
                 @destroy="handleDestroy('yj1')"/>
            <net v-if="visibleCharts['yj2']"
                 id="yj2"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.yj2 ?? { name: ['ËÖî‰ΩìÊ∏©Â∫¶', 'Â∞ÑÈ¢ëÊ∏©Â∫¶', 'ËÖî‰ΩìÊπøÂ∫¶'], ËÖî‰ΩìÊ∏©Â∫¶: [], Â∞ÑÈ¢ëÊ∏©Â∫¶: [], ËÖî‰ΩìÊπøÂ∫¶: [] }"
                 title="ÁéØÂ¢ÉÂÅ•Â∫∑"
                 @destroy="handleDestroy('yj2')"/>

            <net v-if="visibleCharts['net1'] && row.NET1.status !== 'linkdown'"
                 id="NET1"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.NET1 ?? { name:['Rx', 'Tx', 'Ê∏©Â∫¶'],Rx: [], Tx: [], Ê∏©Â∫¶: [] }"
                 title="NET1"
                 @destroy="handleDestroy('net1')"/>

            <net v-if="visibleCharts['net2'] && row.NET2.status !== 'linkdown'"
                 id="NET2"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.NET2 ?? { name:['Rx', 'Tx', 'Ê∏©Â∫¶'],Rx: [], Tx: [], Ê∏©Â∫¶: [] }"
                 title="NET2"
                 @destroy="handleDestroy('net2')"/>

            <net v-if="visibleCharts['net3'] && row.NET3.status !== 'linkdown'"
                 id="NET3"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.NET3 ?? { name:['Rx', 'Tx', 'Ê∏©Â∫¶'],Rx: [], Tx: [], Ê∏©Â∫¶: [] }"
                 title="NET3"
                 @destroy="handleDestroy('net3')"/>

            <net v-if="visibleCharts['net4'] && row.NET4.status !== 'linkdown'"
                 id="NET4"
                 :mac="row.MAC"
                 :realtimeData="row._chartData?.NET4 ?? { name:['Rx', 'Tx', 'Ê∏©Â∫¶'],Rx: [], Tx: [], Ê∏©Â∫¶: [] }"
                 title="NET4"
                 @destroy="handleDestroy('net4')"/>
          </div>
        </template>
      </el-table-column>
      <!-- Â∫èÂè∑Âàó -->
      <el-table-column :width="80" align="center" label="Â∫èÂè∑" type="index">
        <template #default="{ $index }">
          <span>{{ $index + 1 }}</span>
        </template>
      </el-table-column>

      <!-- Âä®ÊÄÅÂàó -->
      <el-table-column
          v-for="column in visibleColumns"
          :key="column.prop"
          :align="column.align"
          :label="column.label"
          :prop="column.prop"
          :width="column.width"
      >
        <template #default="{ row }">
          <!-- IPÂú∞ÂùÄÂèØÁÇπÂáª -->
          <a
              v-if="column.prop === 'ipaddress'"
              style="cursor: pointer;"
              @click="handleIpClick(row.ipaddress)"
          >
            {{ row.ipaddress }}
          </a>

          <!-- Áä∂ÊÄÅÂ≠óÊÆµÁâπÊÆäÂ§ÑÁêÜ -->
          <template v-else-if="column.prop === 'status'">
  <span
      v-if="row.status === 0"
      class="status-dot online"
  ></span>
            <span
                v-else-if="row.status === 1"
                class="status-dot offline"
            ></span>
            <span
                v-else
                style="color: orange; cursor: pointer;"
                @click="handleVerify(row)"
            >
    ÈúÄÈ™åËØÅ
  </span>
          </template>
          <template v-else-if="['NET1', 'NET2', 'NET3', 'NET4'].includes(column.prop)">
            <div>

              <el-text v-if="row[column.prop]?.status === 'linkup'" size="small" type="primary">
                ‚¨áÔ∏è {{ row[column.prop]?.Rx || '0' }} |
                ‚¨ÜÔ∏è {{ row[column.prop]?.Tx || '0' }} |
                üå° {{ row[column.prop]?.Tem || 'N/A' }}
              </el-text>
              <el-text
                  v-else-if="row[column.prop]?.status === 'linkdown'"
                  size="small"
                  type="warning"
              >
                Êú™ËøûÊé•
              </el-text>
              <el-text v-else size="small" type="info">
                Êú™Áü•Áä∂ÊÄÅ
              </el-text>
            </div>
          </template>

          <!-- ÂÖ∂‰ªñÂ≠óÊÆµÈªòËÆ§Â±ïÁ§∫ -->
          <span v-else>{{ row[column.prop] }}</span>
        </template>
      </el-table-column>

      <el-table-column
          align="center"
          class-name="small-padding fixed-width"
          fixed="right"
          label="ËØ¶ÊÉÖ"
          width="120"
      >
        <template #default="{ row }">
          <el-button size="small" type="text" @click="handleViewDetails(row)">ËØ¶ÊÉÖ</el-button>


          <el-dropdown trigger="click" @command="command => handleMoreActions(command, row)"
          >
            <template #default>
              <el-button size="small" type="text">
                <el-icon>
                  <More/>
                </el-icon>
              </el-button>
            </template>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item command="forceLogout">Âº∫ÈÄÄ</el-dropdown-item>
                <el-dropdown-item command="delete">Âà†Èô§</el-dropdown-item>
                <el-dropdown-item command="edit">ÁºñËæë</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </template>
      </el-table-column>
    </el-table>

    <!-- ÂàóËÆæÁΩÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="columnSettingsVisible" :teleport="false" title="ÂàóËÆæÁΩÆ">
      <el-checkbox-group v-model="selectedColumns" class="checkbox-group">
        <div v-for="column in allColumns" :key="column.prop" class="checkbox-item">
          <el-checkbox :label="column.prop">{{ column.label }}</el-checkbox>
        </div>
      </el-checkbox-group>

      <template #footer>
        <el-button @click="columnSettingsVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="applyColumnSettings">‰øùÂ≠ò</el-button>
      </template>
    </el-dialog>

    <!-- ËÆæÂ§áËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="detailDialogVisible" title="ËÆæÂ§áËØ¶ÊÉÖ" width="60vw">
      <el-descriptions
          :column="4"
          border
          content-align="center"
          label-align="center"
          style="width: 100%; text-align: center;"
      >
        <el-descriptions-item align="center" label="IPÂú∞ÂùÄ">{{ detailRow.ipaddress }}</el-descriptions-item>
        <el-descriptions-item align="center" label="Áä∂ÊÄÅ">{{ detailRow.status }}</el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="MACÂú∞ÂùÄ">{{ detailRow.MAC }}</el-descriptions-item>

        <el-descriptions-item align="center" label="Âü∫Â∏¶ÁâàÊú¨">{{ detailRow.BBVersion }}</el-descriptions-item>
        <el-descriptions-item align="center" label="Â∞ÑÈ¢ëÁâàÊú¨">{{ detailRow.Wb_version }}</el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="ÂÜÖÊ†∏ÁâàÊú¨">{{ detailRow.Kernel }}</el-descriptions-item>
        <el-descriptions-item align="center" label="cpu">{{ detailRow.cpu_usage }}</el-descriptions-item>
        <el-descriptions-item align="center" label="ÂÜÖÂ≠ò">{{ detailRow.memory_usage }}</el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="Á°¨Áõò">{{ detailRow.dist_usage }}</el-descriptions-item>
        <el-descriptions-item align="center" label="ËÖî‰ΩìÊ∏©Â∫¶">{{ detailRow.tem }}</el-descriptions-item>
        <el-descriptions-item align="center" label="Â∞ÑÈ¢ëÊ∏©Â∫¶">{{ detailRow.tem_wb }}</el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="ËÖî‰ΩìÊπøÂ∫¶">{{ detailRow.hum }}</el-descriptions-item>

        <el-descriptions-item :span="2" align="center" label="NET1">
          <el-text v-if="detailRow.NET1?.status === 'linkup'" size="small" type="primary">
            ‚¨áÔ∏è {{ detailRow.NET1?.Rx || '0' }} |
            ‚¨ÜÔ∏è {{ detailRow.NET1?.Tx || '0' }} |
            üå° {{ detailRow.NET1?.Tem || 'N/A' }}
          </el-text>
          <el-text
              v-else-if="detailRow.NET1?.status === 'linkdown'"
              size="small"
              type="warning"
          >
            Êú™ËøûÊé•
          </el-text>
        </el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="NET2">
          <el-text v-if="detailRow.NET2?.status === 'linkup'" size="small" type="primary">
            ‚¨áÔ∏è {{ detailRow.NET2?.Rx || '0' }} |
            ‚¨ÜÔ∏è {{ detailRow.NET2?.Tx || '0' }} |
            üå° {{ detailRow.NET2?.Tem || 'N/A' }}
          </el-text>
          <el-text
              v-else-if="detailRow.NET2?.status === 'linkdown'"
              size="small"
              type="warning"
          >
            Êú™ËøûÊé•
          </el-text>
        </el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="NET3">
          <el-text v-if="detailRow.NET3?.status === 'linkup'" size="small" type="primary">
            ‚¨áÔ∏è {{ detailRow.NET3?.Rx || '0' }} |
            ‚¨ÜÔ∏è {{ detailRow.NET3?.Tx || '0' }} |
            üå° {{ detailRow.NET3?.Tem || 'N/A' }}
          </el-text>
          <el-text
              v-else-if="detailRow.NET3?.status === 'linkdown'"
              size="small"
              type="warning"
          >
            Êú™ËøûÊé•
          </el-text>
        </el-descriptions-item>
        <el-descriptions-item :span="2" align="center" label="NET4">
          <el-text v-if="detailRow.NET4?.status === 'linkup'" size="small" type="primary">
            ‚¨áÔ∏è {{ detailRow.NET4?.Rx || '0' }} |
            ‚¨ÜÔ∏è {{ detailRow.NET4?.Tx || '0' }} |
            üå° {{ detailRow.NET4?.Tem || 'N/A' }}
          </el-text>
          <el-text
              v-else-if="detailRow.NET4?.status === 'linkdown'"
              size="small"
              type="warning"
          >
            Êú™ËøûÊé•
          </el-text>
        </el-descriptions-item>
      </el-descriptions>
    </el-dialog>
  </div>
</template>

<script setup>
import {computed, getCurrentInstance, nextTick, onMounted, reactive, ref, watch} from 'vue'
import {ElNotification} from 'element-plus'
import net from './util/net.vue'
import axios from "axios";

const {proxy} = getCurrentInstance();
const expandedRows = ref([])
const rowKey = (row) => row.ipaddress

// ÂàùÂßãÂåñÂõæË°®ÂèØËßÅÊÄßÊéßÂà∂
let visibleCharts = reactive({
  yj1: true,
  yj2: true,
  net1: true,
  net2: true,
  net3: true,
  net4: true,
})
const handleCreate = () => {
  visibleCharts = {
    yj1: true,
    yj2: true,
    net1: true,
    net2: true,
    net3: true,
    net4: true,
  }
  // ÈáçÊñ∞Ëß¶ÂèëËßÜÂõæÊõ¥Êñ∞
  nextTick(() => {
    console.log('Chart created:'); // Á°ÆËÆ§ÂàõÂª∫ÂêéËßÜÂõæÊõ¥Êñ∞
  });
};
const handleDestroy = (chartKey) => {
  visibleCharts[chartKey] = false;
  // ÈáçÊñ∞Ëß¶ÂèëËßÜÂõæÊõ¥Êñ∞
  nextTick(() => {
    console.log('Chart destroyed:', chartKey); // Á°ÆËÆ§ÈîÄÊØÅÂêéËßÜÂõæÊõ¥Êñ∞
  });
};

function handleExpandChange(row) {
  // Âà§Êñ≠ÂΩìÂâçÁÇπÂáªË°åÊòØÂê¶Â∑≤Â±ïÂºÄ
  const currentKey = row.ipaddress
  if (expandedRows.value.includes(currentKey)) {
    // Â∑≤Â±ïÂºÄÂàôÂÖ≥Èó≠
    expandedRows.value = []
  } else {
    // Êú™Â±ïÂºÄÂàôÂè™‰øùÁïôÂΩìÂâçË°å
    expandedRows.value = [currentKey]
  }
}


// Áä∂ÊÄÅÊï∞ÊçÆ
const loading = ref(true)
const total = ref(0)
const savedList = ref([])

// Áî® computed Ê¥æÁîüÂá∫ listDataÔºàÁî®‰∫éË°®Ê†ºÂ±ïÁ§∫
const listData = computed(() => {
  const keyword = queryParams.value.ipaddress?.trim();
  if (!keyword) return savedList.value;
  return savedList.value.filter(item => item.ipaddress?.includes(keyword));
})

const pageNum = ref(1)
const pageSize = ref(10)
const parseNetInfo = (netString) => {
  return {
    status: netString.match(/status:\s*'([^']+)'/)?.[1] ?? 'unknown',
    Rx: netString.match(/Rx:\s*'([^']+)'/)?.[1] ?? 'unknown',
    Tx: netString.match(/Tx:\s*'([^']+)'/)?.[1] ?? 'unknown',
    Tem: netString.match(/Tem:\s*'([^']+)'/)?.[1] ?? 'unknown',
  };
};
const queryParams = ref({
  ipaddress: undefined,
  userName: undefined,
  startIp: '192.168.1.0',
  endIp: '192.168.1.254',
})

const allColumns = ref([
  {label: 'IPÂú∞ÂùÄ', prop: 'ipaddress', align: 'center', width: '100'},
  {label: 'Áä∂ÊÄÅ', prop: 'status', align: 'center'},
  {label: 'MACÂú∞ÂùÄ', prop: 'MAC', align: 'center', width: '130'},
  {label: 'NET1', prop: 'NET1', align: 'center', width: '250'},
  {label: 'NET2', prop: 'NET2', align: 'center', width: '250'},
  {label: 'NET3', prop: 'NET3', align: 'center', width: '250'},
  {label: 'NET4', prop: 'NET4', align: 'center', width: '250'},
  {label: 'Âü∫Â∏¶ÁâàÊú¨', prop: 'BBVersion', align: 'center', width: '130'},
  {label: 'Â∞ÑÈ¢ëÁâàÊú¨', prop: 'Wb_version', align: 'center', width: '130'},
  {label: 'ÂÜÖÊ†∏ÁâàÊú¨', prop: 'Kernel', align: 'center', width: '130'},
  {label: 'CPU', prop: 'cpu_usage', align: 'center'},
  {label: 'ÂÜÖÂ≠ò', prop: 'memory_usage', align: 'center'},
  {label: 'Á°¨Áõò', prop: 'dist_usage', align: 'center'},
  {label: 'ËÖî‰ΩìÊ∏©Â∫¶', prop: 'tem', align: 'center'},
  {label: 'Â∞ÑÈ¢ëÊ∏©Â∫¶', prop: 'tem_wb', align: 'center'},
  {label: 'ËÖî‰ΩìÊπøÂ∫¶', prop: 'hum', align: 'center'},
])

const selectedColumns = ref([
  'ipaddress',
  'status',
  'MAC',
  'cpu_usage',
  'memory_usage',
  'dist_usage',
  'tem',
  'tem_wb',
  'hum',
])

const columnSettingsVisible = ref(false)
const detailDialogVisible = ref(false)
const detailRow = ref({})

// ËÆ°ÁÆóÂ±ûÊÄß
const visibleColumns = computed(() =>
    allColumns.value.filter((col) => selectedColumns.value.includes(col.prop))
)

const onlineCount = computed(() =>
    savedList.value.filter((item) => item.status === 0).length
)


function resetQuery() {
  queryParams.value = {ipaddress: undefined, userName: undefined}
}

function handleForceLogout(row) { /* ‰øùÊåÅÂéüÈÄªËæë */
}

function showColumnSettings() {
  columnSettingsVisible.value = true
}

function applyColumnSettings() {
  //Â∞ÜselectedColumns.valueÂ≠òÂà∞ÊµèËßàÂô®ÁºìÂ≠ò
  localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns.value));

  columnSettingsVisible.value = false
}

function handleIpClick(ipaddress) {
  //Ë∑≥ËΩ¨
  window.open(`http://${ipaddress}`, '_blank');
}

function handleViewDetails(row) {
  detailRow.value = row;
  detailDialogVisible.value = true
}

function handleMoreActions(command, row) { /* ‰øùÊåÅÂéüÈÄªËæë */
}

function handleDelete(row) { /* ‰øùÊåÅÂéüÈÄªËæë */
}

function handleEdit(row) {
  alert(`ÁºñËæë ${row.userName}`)
}

function handlePing(row) { /* Ê®°Êãü ping */
}

function handleVerify(row) { /* ÂºπÂá∫È™åËØÅÊ°Ü */
}

function tableRowClassName({row}) {
  return row.status === 2 ? 'verify-row' : ''
}

function handleRefresh() {
  // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞
  let params = {
    startIp: queryParams.value.startIp,
    endIp: queryParams.value.endIp,
  };

  // ÂèØÈÄâÂà∑Êñ∞Êé•Âè£ÈÄªËæë
  console.log(params);

  // ‰øÆÊîπËØ∑Ê±Ç URL ‰∏∫Ê≠£Á°ÆÁöÑÂú∞ÂùÄÂíåÁ´ØÂè£
  axios.post('http://192.168.2.28:8001/ssdp/scan-range', params)
      .then(response => {
        console.log('Êâ´ÊèèÊàêÂäü:', response.data);
      })
      .catch(error => {
        console.error('Êâ´ÊèèÂ§±Ë¥•:', error);
      });
}


const setData = (Res) => {
  const updateDeviceData = (item, data) => {
    console.log("====", data);
    item.status = 0;

    // Êõ¥Êñ∞ÈùôÊÄÅÂ≠óÊÆµ
    Object.assign(item, {
      MAC: data.MAC ?? item.MAC,
      BBVersion: data.BBVersion ?? item.BBVersion,
      Wb_version: data.Wb_version ?? item.Wb_version,
      Kernel: data.Kernel ?? item.Kernel,
      cpu_usage: data.cpu_usage !== undefined ? (data.cpu_usage * 100).toFixed(1) + "%" : item.cpu_usage,
      memory_usage: data.memory_usage !== undefined ? (data.memory_usage * 100).toFixed(1) + "%" : item.memory_usage,
      dist_usage: data.dist_usage !== undefined ? (data.dist_usage * 100).toFixed(1) + "%" : item.dist_usage,
      tem: data.tem !== undefined ? data.tem + "¬∞C" : item.tem,
      tem_wb: data.tem_wb !== undefined ? data.tem_wb + "¬∞C" : item.tem_wb,
      hum: data.hum !== undefined ? data.hum + "%" : item.hum,
      NET1: parseNetInfo(data.Net1),
      NET2: parseNetInfo(data.Net2),
      NET3: parseNetInfo(data.Net3),
      NET4: parseNetInfo(data.Net4),
    });

// ‚úÖ Ê≠£Á°ÆÂú∞ÂçïÁã¨ÂàùÂßãÂåñ _chartDataÔºàObject.assign Â§ñÔºâ
    if (!item._chartData) {
      item._chartData = {
        yj1: {
          name: ['cpu', 'ÂÜÖÂ≠ò', 'Á°¨Áõò'],
          cpu: [],
          ÂÜÖÂ≠ò: [],
          Á°¨Áõò: [],
        },
        yj2: {
          name: ['ËÖî‰ΩìÊ∏©Â∫¶', 'Â∞ÑÈ¢ëÊ∏©Â∫¶', 'ËÖî‰ΩìÊπøÂ∫¶'],
          ËÖî‰ΩìÊ∏©Â∫¶: [],
          Â∞ÑÈ¢ëÊ∏©Â∫¶: [],
          ËÖî‰ΩìÊπøÂ∫¶: [],
        },
        NET1: {
          name: ['Rx', 'Tx', 'Ê∏©Â∫¶'],
          Rx: [],
          Tx: [],
          Ê∏©Â∫¶: []
        },
        NET2: {
          name: ['Rx', 'Tx', 'Ê∏©Â∫¶'],
          Rx: [],
          Tx: [],
          Ê∏©Â∫¶: []
        },
        NET3: {
          name: ['Rx', 'Tx', 'Ê∏©Â∫¶'],
          Rx: [],
          Tx: [],
          Ê∏©Â∫¶: []
        },
        NET4: {
          name: ['Rx', 'Tx', 'Ê∏©Â∫¶'],
          Rx: [],
          Tx: [],
          Ê∏©Â∫¶: []
        }
      }
    }

// ‚úÖ Ê∑ªÂä†ÂÆûÊó∂Êï∞ÊçÆÁÇπÔºà‰øùÊåÅÊúÄÂ§ö 600 ‰∏™Ôºâ
    const now = new Date()

// ÊîπÈÄ†ÂêéÁöÑ pushData ÊîØÊåÅÂàÜÁªÑÁªìÊûÑ
    const pushData = (group, key, rawValue) => {
      const value = Number(rawValue?.toFixed?.(1) ?? rawValue ?? 0)
      const arr = item._chartData[group][key]

      arr.push({time: now, value})

      // Â¶ÇÊûúÊï∞ÈáèÂ∞ë‰∫é 600ÔºåÂ∞±Áî®È¶ñÂÄºÂ°´ÂÖÖÂâçÈù¢
      while (arr.length < 600) {
        arr.unshift({time: new Date(now - (600 - arr.length) * 1000), value})
      }

      if (arr.length > 600) arr.shift()
    }

// ‚úÖ ÊåâÁÖßÂàÜÁªÑÁªìÊûÑË∞ÉÁî®
    pushData('yj1', 'cpu', data.cpu_usage * 100)
    pushData('yj1', 'ÂÜÖÂ≠ò', data.memory_usage * 100)
    pushData('yj1', 'Á°¨Áõò', data.dist_usage * 100)

    pushData('yj2', 'ËÖî‰ΩìÊ∏©Â∫¶', data.tem)
    pushData('yj2', 'Â∞ÑÈ¢ëÊ∏©Â∫¶', data.tem_wb)
    pushData('yj2', 'ËÖî‰ΩìÊπøÂ∫¶', data.hum)

    // ‚úÖ ÁΩëÁªúÂè£Êï∞ÊçÆÔºàRx„ÄÅTx„ÄÅÊ∏©Â∫¶ÔºâÁªü‰∏ÄËøΩÂä†ÂáΩÊï∞
    const pushNetData = (netKey, rxRaw, txRaw, temRaw) => {
      const netGroup = item._chartData[netKey]
      const push = (arr, value) => {
        value = Number(value?.toFixed?.(1) ?? value ?? 0)
        arr.push({time: now, value})
        while (arr.length < 600) {
          arr.unshift({time: new Date(now - (600 - arr.length) * 1000), value})
        }
        if (arr.length > 600) arr.shift()
      }

      push(netGroup.Rx, rxRaw)
      push(netGroup.Tx, txRaw)
      push(netGroup.Ê∏©Â∫¶, temRaw)
    }

// ‚úÖ Ëß£ÊûêÂπ∂ËøΩÂä†Êï∞ÊçÆ
    const net1 = parseNetInfo(data.Net1)
    const net2 = parseNetInfo(data.Net2)
    const net3 = parseNetInfo(data.Net3)
    const net4 = parseNetInfo(data.Net4)

    pushNetData('NET1', parseFloat(net1.Rx), parseFloat(net1.Tx), parseFloat(net1.Tem))
    pushNetData('NET2', parseFloat(net2.Rx), parseFloat(net2.Tx), parseFloat(net2.Tem))
    pushNetData('NET3', parseFloat(net3.Rx), parseFloat(net3.Tx), parseFloat(net3.Tem))
    pushNetData('NET4', parseFloat(net4.Rx), parseFloat(net4.Tx), parseFloat(net4.Tem))

// ‚úÖ ÈôêÂà∂ÈïøÂ∫¶
    for (const key in item._chartData) {
      const chartItem = item._chartData[key]
      if (Array.isArray(chartItem)) {
        // ÊôÆÈÄöÊï∞ÁªÑÂõæË°®Â≠óÊÆµ
        if (chartItem.length > 600) chartItem.shift()
      } else if (typeof chartItem === 'object' && chartItem !== null) {
        // ÁΩëÁªúÂè£ÂõæË°® NET1~NET4
        for (const subKey in chartItem) {
          if (Array.isArray(chartItem[subKey]) && chartItem[subKey].length > 600) {
            chartItem[subKey].shift()
          }
        }
      }
    }
    console.log("üöÄ ~ file: index.vue:107 ~ setData ~ item:", item);
  };

  if (Res.type === "ËÆæÂ§áÂõûÂ§ç") {
    lastResponseTime = Date.now(); // ‚úÖ Êõ¥Êñ∞ÊúÄÂêéÂìçÂ∫îÊó∂Èó¥
    notified.value = false;
    try {
      const Data = JSON.parse(Res.message);
      const linkinfos = Data?.RESP?.Data?.linkinfos;
      if (!linkinfos) return;
      const cleanMac = Res.mac.replace(/^"|"$/g, ""); // ÂéªÊéâÈ¶ñÂ∞æÁöÑÂºïÂè∑
      const item = savedList.value.find(item => item.ipaddress === Res.ip && item.MAC === cleanMac);
      if (item) {
        updateDeviceData(item, linkinfos);
      } else {
        savedList.value.push({
          ipaddress: Res.ip,
          status: 0,
          MAC: linkinfos.MAC,
          BBVersion: linkinfos.BBVersion,
          Wb_version: linkinfos.Wb_version,
          Kernel: linkinfos.Kernel,
          cpu_usage: linkinfos.cpu_usage * 100 + "%",
          memory_usage: linkinfos.memory_usage * 100 + "%",
          dist_usage: linkinfos.dist_usage * 100 + "%",
          tem: linkinfos.tem + "¬∞C",
          tem_wb: linkinfos.tem_wb + "¬∞C",
          hum: linkinfos.hum + "%",
          NET1: parseNetInfo(linkinfos.Net1),
          NET2: parseNetInfo(linkinfos.Net2),
          NET3: parseNetInfo(linkinfos.Net3),
          NET4: parseNetInfo(linkinfos.Net4),
        });
      }
    } catch (err) {
      console.error("Ëß£ÊûêËÆæÂ§áÂõûÂ§çÂ§±Ë¥•Ôºö", err);
    }

  } else if (Res.type === "ËÆæÂ§á‰∏äÁ∫ø") {
    lastResponseTime = Date.now(); // ‚úÖ Êõ¥Êñ∞ÊúÄÂêéÂìçÂ∫îÊó∂Èó¥
    notified.value = false;
    ElNotification({
      title: 'ËÆæÂ§á‰∏äÁ∫øÔºÅ' + `${Res.ip}`,
      message: `MAC: ${Res.mac}`,
      type: 'success',
      dangerouslyUseHTMLString: true
    })
  } else if (Res.type === "ËÆæÂ§áÁ¶ªÁ∫ø") {
    lastResponseTime = Date.now(); // ‚úÖ Êõ¥Êñ∞ÊúÄÂêéÂìçÂ∫îÊó∂Èó¥
    notified.value = false;
    const item = savedList.value.find(item => item.ipaddress === Res.ip);
    if (item) item.status = 1;
    ElNotification({
      title: 'ËÆæÂ§áÁ¶ªÁ∫øÔºÅ' + `${Res.ip}`,
      message: `MAC: ${Res.mac}`,
      type: 'info',
      dangerouslyUseHTMLString: true
    })
  }
};

function getWs() {
  proxy.$WebSoket.onmessage((msg) => {
    try {
      const Res = JSON.parse(msg);
      setData(Res);
    } catch (err) {
      setData(msg);
    }
  })
}

let lastResponseTime = Date.now()
let notified = ref(false) // Áî®Êõ¥ËØ≠‰πâÂåñÁöÑÂèòÈáèÂêçÊõ¥Ê∏ÖÊô∞

// ÂÆöÊó∂Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÊó∂Êú™Êî∂Âà∞ËÆæÂ§áÂìçÂ∫î
setInterval(() => {
  const now = Date.now()
  if (now - lastResponseTime > 2000 && !notified.value) {
    //Âà§Êñ≠ savedList.valueÈáåÈù¢ÊúâËÆæÂ§áÂú®Á∫øÁöÑ
    if (savedList.value.some(item => item.status === 0)) {
      // ÊèêÁ§∫ÁΩëÁªú‰∏≠Êñ≠
      savedList.value.forEach(item => {
        if (item.status !== 1) {
          item.status = 1
        }
      })
    }
    notified.value = true

  }
}, 1000)
//ÁõëÂê¨queryParams.ipaddress
watch(
    () => queryParams.value.ipaddress,
    (newVal, oldVal) => {
      if (newVal !== oldVal) {
        if (newVal && newVal.trim() !== '') {
          // Ê®°Á≥äÂåπÈÖçÁ≠õÈÄâ
          listData.value = savedList.value.filter(item =>
              item.ipaddress && item.ipaddress.includes(newVal)
          )
        } else {
          // ‰∏∫Á©∫ÂàôÊÅ¢Â§çÂÖ®ÈÉ®Êï∞ÊçÆ
          listData.value = [...savedList.value]
        }
      }
    }
)
onMounted(() => {
  const savedStr = localStorage.getItem('selectedColumns')
  if (savedStr) {
    selectedColumns.value = JSON.parse(savedStr)
  }
  getWs()
  loading.value = false
})
</script>

<style scoped>
.app-container {
  min-width: 850px;
  padding-top: 30px; /* Ë°®ÂçïÈ´òÂ∫¶ + ÁÇπ‰ΩôÈáèÔºåÈò≤Ê≠¢ÈÅÆÊå°Ë°®Ê†º */
  overflow-y: hidden; /* ÈöêËóèÂûÇÁõ¥ÊªöÂä®Êù° */
}

.checkbox-group {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
}

.checkbox-item {
  display: flex;
  align-items: center;
}

.form-wrapper {
  position: fixed;
  top: 35px;
  left: 0;
  right: 0;
  z-index: 1000;
  background-color: rgba(158, 141, 204, 0.8);
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  height: 35px;
  min-width: 850px;
}

.form-left {
  flex: 3;
  min-width: 415px;
  margin-left: 10px;
}

.form-right {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  flex: 2.8;
}

::v-deep .verify-row {
  background-color: #fff9e6 !important;
}

.status-dot {
  display: inline-block;
  width: 15px;
  height: 15px;
  border-radius: 50%;
  margin-right: 5px;
  margin-bottom: -2px;
}

.status-dot.online {
  background-color: #a18cd1;
  animation: pulse 1.4s infinite;
}

.status-dot.offline {
  background-color: gray;
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.4) translateY(1px); /* Á®çÂæÆÊîæÂ§ßÂπ∂‰∏ãÁßª2px */
    opacity: 0.6;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.chart-container {
  width: 100vw;
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* ÊØèË°åÊòæÁ§∫3‰∏™ÁªÑ‰ª∂ */
  gap: 10px; /* ÂÖÉÁ¥†Èó¥ÁöÑÈó¥Èöô */
}

.chart-container > * {
  width: calc(100%); /* ‰ΩøÊØè‰∏™ÁªÑ‰ª∂ÁöÑÂÆΩÂ∫¶Â°´Êª°ÂêÑËá™ÁöÑÁΩëÊ†ºÂçïÂÖÉ */
}

</style>
